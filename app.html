<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lost & Found Hub</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Montserrat:wght@400;700;800;900&family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Light background for overall page */
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem;
        }
        .card {
            background-color: #fff;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .btn-primary {
            background-color: #4f46e5; /* indigo-600 */
            color: #fff;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem; /* rounded-lg */
            font-weight: 600;
            transition: background-color 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #4338ca; /* indigo-700 */
        }
        .btn-secondary {
            background-color: #e5e7eb; /* gray-200 */
            color: #374151; /* gray-700 */
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.3s ease;
        }
        .btn-secondary:hover {
            background-color: #d1d5db; /* gray-300 */
        }
        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="date"], /* Added date type */
        textarea,
        select {
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            width: 100%;
            font-size: 1rem;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        input[type="file"] { /* Style for file input */
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            width: 100%;
            font-size: 1rem;
            background-color: #fdfdfd;
            cursor: pointer;
        }
        input[type="text"]:focus,
        input[type="email"]:focus,
        input[type="tel"]:focus,
        input[type="date"]:focus, /* Added date type */
        textarea:focus,
        select:focus,
        input[type="file"]:focus { /* Added file type */
            border-color: #6366f1; /* indigo-500 */
            outline: none;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); /* indigo-500 with opacity */
        }
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4CAF50; /* Green */
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        .message-box.show {
            opacity: 1;
        }
        .message-box.error {
            background-color: #f44336; /* Red */
        }
        /* Chat specific styles */
        #chatMessages, #privateChatMessages {
            display: flex;
            flex-direction: column;
            gap: 0.75rem; /* space-y-3 */
            height: 400px; /* Fixed height for scrollability */
            overflow-y: auto; /* Enable vertical scrolling */
            padding-right: 10px; /* Space for scrollbar */
        }
        .chat-message {
            background-color: #e0e7ff; /* indigo-100 */
            padding: 0.75rem 1rem;
            border-radius: 0.75rem; /* rounded-lg */
            max-width: 80%;
            align-self: flex-start;
            word-wrap: break-word;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        .chat-message.self {
            background-color: #c7d2fe; /* indigo-200 */
            align-self: flex-end;
        }
        .chat-message .sender {
            font-weight: 600; /* font-semibold */
            color: #374151; /* gray-700 */
            margin-bottom: 0.25rem;
        }
        .chat-message .timestamp {
            font-size: 0.75rem; /* text-xs */
            color: #6b7280; /* gray-500 */
            text-align: right;
            margin-top: 0.25rem;
        }
        /* Home section specific styles */
        #home {
            background: linear-gradient(135deg, #6366f1 0%, #818cf8 100%); /* Indigo gradient */
            color: white;
            padding: 4rem 1.5rem;
            border-radius: 1rem;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        #home .text-4xl {
            font-size: 3.5rem; /* Larger heading */
            line-height: 1.1;
        }
        #home .text-lg {
            font-size: 1.25rem;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }

        /* --- Report Item Form Specific Styles (Enhanced) --- */
        #report-item .card {
            background-color: #ffffff;
            border-radius: 1.5rem; /* More rounded */
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1); /* Stronger shadow */
            padding: 3rem; /* More padding */
            border: 1px solid #e2e8f0; /* Subtle border */
            animation: fadeInScale 0.8s ease-out forwards;
        }
        #report-item h2 {
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            color: #374151; /* Darker text */
            margin-bottom: 2rem; /* More space below heading */
            text-align: center;
        }
        #report-item label {
            font-family: 'Poppins', sans-serif;
            font-weight: 600; /* Semibold labels */
            color: #4b5563; /* Slightly darker gray */
            margin-bottom: 0.5rem;
            font-size: 0.95rem; /* Slightly larger label font */
        }
        #report-item input[type="text"],
        #report-item input[type="email"],
        #report-item input[type="tel"],
        #report-item input[type="date"],
        #report-item textarea,
        #report-item select {
            border: 2px solid #cbd5e1; /* Thicker border */
            border-radius: 0.75rem; /* More rounded inputs */
            padding: 0.85rem 1.25rem; /* More padding */
            font-size: 1rem;
            background-color: #fdfdfd; /* Almost white background */
            transition: all 0.3s ease;
        }
        #report-item input[type="text"]:focus,
        #report-item input[type="email"]:focus,
        #report-item input[type="tel"]:focus,
        #report-item input[type="date"]:focus,
        #report-item textarea:focus,
        #report-item select:focus {
            border-color: #4f46e5; /* Primary indigo on focus */
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.3); /* Prominent focus ring */
            background-color: #fff;
        }
        #report-item textarea {
            min-height: 120px; /* Taller textarea */
            resize: vertical; /* Allow vertical resize */
        }
        #report-item .btn-primary {
            background: linear-gradient(90deg, #4f46e5 0%, #6366f1 100%);
            color: #fff;
            padding: 0.9rem 2rem;
            border-radius: 0.75rem;
            font-weight: 700;
            box-shadow: 0 5px 15px rgba(79, 70, 229, 0.3);
            transition: all 0.3s ease;
        }
        #report-item .btn-primary:hover {
            background-position: right center;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(79, 70, 229, 0.4);
        }
        #report-item .btn-secondary {
            background-color: #e2e8f0; /* Light gray */
            color: #4b5563; /* Darker text */
            padding: 0.9rem 2rem;
            border-radius: 0.75rem;
            font-weight: 600;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
        #report-item .btn-secondary:hover {
            background-color: #cbd5e1; /* Slightly darker gray on hover */
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        /* Keyframe for fadeInScale (used by report-item card) */
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        /* Admin Panel Specific Styles */
        .admin-table th, .admin-table td {
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            text-align: left;
        }
        .admin-table th {
            background-color: #f8fafc;
            font-weight: 600;
            color: #4b5563;
        }
        .admin-table tr:nth-child(even) {
            background-color: #fcfcfc;
        }
        .admin-table .btn-delete {
            background-color: #ef4444; /* Red-500 */
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 0.375rem; /* rounded-md */
            font-size: 0.875rem;
            transition: background-color 0.3s ease;
        }
        .admin-table .btn-delete:hover {
            background-color: #dc2626; /* Red-600 */
        }
        .admin-table .btn-report-status { /* Style for admin report status button */
            background-color: #3b82f6; /* Blue-500 */
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            transition: background-color 0.3s ease;
        }
        .admin-table .btn-report-status.reported {
            background-color: #10b981; /* Green-500 */
        }
        .admin-table .btn-report-status:hover {
            background-color: #2563eb; /* Blue-600 */
        }
        .admin-table .btn-report-status.reported:hover {
            background-color: #059669; /* Green-600 */
        }
        .btn-mark-resolved { /* New style for mark as resolved button */
            background-color: #22c55e; /* Green-500 */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.3s ease;
        }
        .btn-mark-resolved:hover {
            background-color: #16a34a; /* Green-600 */
        }
        /* Private Chat specific styles */
        #privateChatUsersList {
            list-style: none;
            padding: 0;
        }
        #privateChatUsersList li {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e2e8f0;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        #privateChatUsersList li:hover {
            background-color: #f0f4f8;
        }
        #privateChatUsersList li.selected {
            background-color: #e0e7ff;
            font-weight: 600;
        }
        #privateChatWindow {
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            background-color: #fcfcfc;
            display: flex;
            flex-direction: column;
            height: 400px;
            margin-top: 1rem;
        }
        .private-message-input-area {
            display: flex;
            padding: 1rem;
            border-top: 1px solid #e2e8f0;
        }
        .private-message-input-area input {
            flex-grow: 1;
            margin-right: 0.5rem;
        }
        .private-chat-message-container {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
        }
    </style>
</head>
<body>

    <!-- Message Box for alerts -->
    <div id="messageBox" class="message-box"></div>

    <header class="bg-indigo-600 text-white py-4 shadow-md">
        <div class="container flex justify-between items-center">
            <h1 class="text-3xl font-bold">Lost & Found Hub</h1>
            <nav>
                <ul class="flex space-x-6 items-center">
                    <li><a href="#home" class="hover:text-indigo-200 transition duration-300">Home</a></li>
                    <li><a href="#lost-items" class="hover:text-indigo-200 transition duration-300">Lost Items</a></li>
                    <li><a href="#found-items" class="hover:text-indigo-200 transition duration-300">Found Items</a></li>
                    <li><a href="#report-item" class="hover:text-indigo-200 transition duration-300">Report Item</a></li>
                    <li><a href="#chat-option" class="hover:text-indigo-200 transition duration-300">Community Chat</a></li>
                    <li id="privateChatNavLink"> <!-- Always visible, but functionality depends on user -->
                        <a href="#private-chat" class="hover:text-indigo-200 transition duration-300">Private Chat</a>
                    </li>
                    <li id="adminPanelNavLink" class="hidden ml-6"> <!-- Hidden by default -->
                        <a href="#admin-panel" class="bg-indigo-700 hover:bg-indigo-800 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">Admin Panel</a>
                    </li>
                    <li class="ml-6">
                        <button id="signOutBtn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">Sign Out</button>
                    </li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="flex-grow container py-8">

        <!-- Home Section -->
        <section id="home" class="card text-center mb-8">
            <h2 class="text-4xl font-extrabold mb-4">Your Community's Lost & Found</h2>
            <p class="text-lg mb-6">Easily report lost items or help reunite found belongings with their rightful owners. Connect with others in your community.</p>
            <div class="flex justify-center space-x-4">
                <a href="#report-item" class="btn-primary inline-block bg-white text-indigo-700 hover:bg-gray-100">Report an Item</a>
                <a href="#lost-items" class="btn-secondary inline-block bg-white text-indigo-700 hover:bg-gray-100">View Lost Items</a>
            </div>
        </section>

        <!-- Report Item Section -->
        <section id="report-item" class="card hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Report a Lost or Found Item</h2>
            <form id="itemForm" class="space-y-6" enctype="multipart/form-data"> <!-- Added enctype for file upload -->
                <div>
                    <label for="itemType" class="block text-gray-700 text-sm font-semibold mb-2">Type of Report:</label>
                    <select id="itemType" name="itemType" required class="block w-full">
                        <option value="">Select...</option>
                        <option value="lost">Lost Item</option>
                        <option value="found">Found Item</option>
                    </select>
                </div>
                <div>
                    <label for="itemName" class="block text-gray-700 text-sm font-semibold mb-2">Item Name:</label>
                    <input type="text" id="itemName" name="itemName" placeholder="e.g., Blue backpack, Silver watch" required class="block w-full">
                </div>
                <div>
                    <label for="description" class="block text-gray-700 text-sm font-semibold mb-2">Description:</label>
                    <textarea id="description" name="description" rows="4" placeholder="Provide details like brand, color, distinguishing marks, contents, etc." required class="block w-full"></textarea>
                </div>
                <div id="locationField">
                    <label for="location" class="block text-gray-700 text-sm font-semibold mb-2">Location (where it was lost/found):</label>
                    <input type="text" id="location" name="location" placeholder="e.g., Library, Park, Bus Stop" required class="block w-full">
                </div>
                <div id="dateField">
                    <label for="date" class="block text-gray-700 text-sm font-semibold mb-2">Date (when it was lost/found):</label>
                    <input type="date" id="date" name="date" required class="block w-full">
                </div>
                <div>
                    <label for="itemPhoto" class="block text-gray-700 text-sm font-semibold mb-2">Upload Photo (Optional):</label>
                    <input type="file" id="itemPhoto" name="itemPhoto" accept="image/*" class="block w-full">
                </div>
                <div>
                    <label for="contactName" class="block text-gray-700 text-sm font-semibold mb-2">Your Name:</label>
                    <input type="text" id="contactName" name="contactName" placeholder="Your Full Name" required class="block w-full">
                </div>
                <div>
                    <label for="contactEmail" class="block text-gray-700 text-sm font-semibold mb-2">Your Email:</label>
                    <input type="email" id="contactEmail" name="contactEmail" placeholder="your.email@example.com" required class="block w-full">
                </div>
                <div>
                    <label for="contactPhone" class="block text-gray-700 text-sm font-semibold mb-2">Your Phone (Optional):</label>
                    <input type="tel" id="contactPhone" name="contactPhone" placeholder="+1234567890" class="block w-full">
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="reset" class="btn-secondary">Clear Form</button>
                    <button type="submit" class="btn-primary">Submit Report</button>
                </div>
            </form>
        </section>

        <!-- Lost Items Section -->
        <section id="lost-items" class="card hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Lost Items</h2>
            <div id="lostItemsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Lost items will be dynamically loaded here -->
                <p class="text-gray-600 text-center col-span-full">No lost items reported yet. Be the first!</p>
            </div>
        </section>

        <!-- Found Items Section -->
        <section id="found-items" class="card hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Found Items</h2>
            <div id="foundItemsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Found items will be dynamically loaded here -->
                <p class="text-gray-600 text-center col-span-full">No found items reported yet. Check back soon!</p>
            </div>
        </section>

        <!-- Community Chat Section -->
        <section id="chat-option" class="card hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Community Chat</h2>
            <p class="text-sm text-gray-600 mb-4">
                This chat requires a PHP server to save messages in `chat.json`. Messages are shared across users.
            </p>
            <div class="flex flex-col bg-gray-50 rounded-lg p-4 mb-4 overflow-y-auto border border-gray-200" id="chatMessages">
                <!-- Chat messages will be loaded here -->
                <p class="text-gray-600 text-center">Loading chat messages...</p>
            </div>
            <div class="flex items-center space-x-3">
                <input type="text" id="chatInput" placeholder="Type your message..." class="flex-grow">
                <button id="sendMessageBtn" class="btn-primary px-6 py-2">Send</button>
            </div>
            <p id="currentUserNameDisplay" class="text-sm text-gray-500 mt-4">Signed in as: Loading...</p>
        </section>

        <!-- Private Chat Section -->
        <section id="private-chat" class="card hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Private Chat</h2>

            <div id="privateChatSelection" class="mb-4">
                <div id="adminChatList" class="hidden"> <!-- Admin view -->
                    <h3 class="text-xl font-semibold text-gray-700 mb-2">Select User to Chat With:</h3>
                    <ul id="privateChatUsersList" class="bg-gray-50 border border-gray-200 rounded-lg max-h-60 overflow-y-auto">
                        <li class="p-4 text-gray-500">Loading users...</li>
                    </ul>
                </div>
                <div id="userChatAdmin" class="hidden"> <!-- Regular user view -->
                    <h3 class="text-xl font-semibold text-gray-700 mb-2">Chat with Administrator:</h3>
                    <button id="startAdminChatBtn" class="btn-primary">Start Chat with Admin</button>
                </div>
            </div>

            <div id="privateChatWindow" class="hidden">
                <h3 id="privateChatPartnerName" class="text-xl font-semibold text-indigo-700 p-4 border-b border-gray-200">Chat with: </h3>
                <div id="privateChatMessages" class="private-chat-message-container">
                    <p class="text-gray-600 text-center">Select a user to start chatting.</p>
                </div>
                <div class="private-message-input-area">
                    <input type="text" id="privateChatInput" placeholder="Type your private message..." class="flex-grow">
                    <button id="sendPrivateMessageBtn" class="btn-primary px-6 py-2">Send</button>
                </div>
            </div>
        </section>


        <!-- Admin Panel Section (Hidden by default) -->
        <section id="admin-panel" class="card hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Admin Dashboard</h2>

            <div class="mb-8">
                <h3 class="text-2xl font-semibold text-gray-700 mb-4">Manage Items</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border border-gray-200 rounded-lg admin-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Type</th>
                                <th>Name</th>
                                <th>Reporter</th>
                                <th>Date</th>
                                <th>Image</th> <!-- New column -->
                                <th>Reported</th> <!-- New column -->
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="adminItemsList">
                            <tr><td colspan="8" class="text-center text-gray-500">Loading items...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div>
                <h3 class="text-2xl font-semibold text-gray-700 mb-4">Manage Users</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border border-gray-200 rounded-lg admin-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Username</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="adminUsersList">
                            <tr><td colspan="3" class="text-center text-gray-500">Loading users...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

    </main>

    <footer class="bg-gray-800 text-white py-6 text-center mt-auto">
        <div class="container">
            <p>&copy; 2025 Lost & Found Hub. All rights reserved.</p>
        </div>
    </footer>

    <script>
        // Utility function to show messages
        function showMessage(message, type = 'success') {
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = message;
            messageBox.className = 'message-box'; // Reset classes
            if (type === 'error') {
                messageBox.classList.add('error');
            }
            messageBox.classList.add('show');

            setTimeout(() => {
                messageBox.classList.remove('show');
            }, 3000); // Message disappears after 3 seconds
        }

        // --- User Session Management ---
        let currentUserId = null; // Will be set from PHP session
        let currentUserName = null; // Will be set from PHP session
        let isAdmin = false; // Flag to determine admin access
        let adminUserId = null; // Stores the actual user ID of the 'admin' user
        let adminUsername = null; // Stores the actual username of the 'admin' user (should be 'admin')

        const currentUserNameDisplay = document.getElementById('currentUserNameDisplay');
        const signOutBtn = document.getElementById('signOutBtn');
        const adminPanelNavLink = document.getElementById('adminPanelNavLink'); // Admin nav link element
        const privateChatNavLink = document.getElementById('privateChatNavLink'); // Private chat nav link

        // Check if user is signed in on page load
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch('check_session.php'); // PHP endpoint to check session
                const result = await response.json();

                if (result.loggedIn) {
                    currentUserId = result.userId;
                    currentUserName = result.username;
                    adminUserId = result.adminId; // Get admin's actual ID
                    adminUsername = result.adminUsername; // Get admin's username

                    currentUserNameDisplay.textContent = `Signed in as: ${currentUserName} (ID: ${currentUserId.substring(0, 8)}...)`;
                    document.getElementById('home').classList.remove('hidden'); // Show home section by default

                    // Client-side check for admin username (for UI visibility only)
                    if (currentUserName === 'admin') { // Hardcoded admin username
                        isAdmin = true;
                        adminPanelNavLink.classList.remove('hidden'); // Show admin panel link
                    }

                } else {
                    // If no user data in session, redirect to login page
                    console.log('No active user session. Redirecting to index.html (login page).');
                    window.location.href = 'index.html'; // Redirect to your login page
                }
            } catch (error) {
                console.error('Error checking session:', error);
                showMessage('Could not verify login status. Please try logging in again.', 'error');
                // Redirect to login page as a fallback if session check fails
                setTimeout(() => { window.location.href = 'index.html'; }, 2000);
            }
        });

        // Sign Out functionality
        signOutBtn.addEventListener('click', async () => {
            try {
                const response = await fetch('logout.php'); // PHP endpoint for logout
                const result = await response.json();

                if (response.ok && result.success) {
                    showMessage('Signed out successfully!', 'success');
                    // Clear local variables (though PHP session is the source of truth now)
                    currentUserId = null;
                    currentUserName = null;
                    isAdmin = false; // Reset admin status
                    adminUserId = null; // Clear admin ID
                    adminUsername = null; // Clear admin username
                    setTimeout(() => {
                        window.location.href = 'index.html'; // Redirect to login page
                    }, 1000);
                } else {
                    showMessage(result.message || 'Logout failed.', 'error');
                }
            } catch (error) {
                console.error('Logout error:', error);
                showMessage('Network error during logout. Please try again.', 'error');
            }
        });


        // --- Navigation ---
        // Updated selector to include navigation links from the main menu AND the home section buttons
        const navLinks = document.querySelectorAll('nav a, #home .btn-primary, #home .btn-secondary');
        const sections = document.querySelectorAll('main section');

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = link.getAttribute('href').substring(1); // Get section ID

                sections.forEach(section => {
                    section.classList.add('hidden'); // Hide all sections
                });

                document.getElementById(targetId).classList.remove('hidden'); // Show target section

                // Clear all polling intervals when navigating
                clearInterval(chatPollingInterval);
                clearInterval(privateChatPollingInterval);
                chatPollingInterval = null;
                privateChatPollingInterval = null;

                // Specific actions for each section
                if (targetId === 'lost-items') {
                    fetchItems('lost');
                } else if (targetId === 'found-items') {
                    fetchItems('found');
                } else if (targetId === 'chat-option') {
                    fetchChatMessages(); // Initial fetch
                    chatPollingInterval = setInterval(fetchChatMessages, 3000); // Start polling
                } else if (targetId === 'private-chat') {
                    setupPrivateChatUI(); // Setup private chat UI based on user role
                    // Polling for private chat will start after a chat partner is selected
                }
                else if (targetId === 'admin-panel') {
                    if (isAdmin) { // Only fetch admin data if user is recognized as admin
                        fetchAllItemsForAdmin();
                        fetchAllUsersForAdmin();
                    } else {
                        showMessage('Access Denied: You are not authorized to view the admin panel.', 'error');
                        document.getElementById('admin-panel').classList.add('hidden'); // Ensure it stays hidden
                    }
                }
            });
        });


        // --- Form Submission (for Lost/Found Items) ---
        const itemForm = document.getElementById('itemForm');
        itemForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Use FormData to correctly handle file uploads
            const formData = new FormData(itemForm);

            // Add user info to the FormData
            formData.append('reporterId', currentUserId);
            formData.append('reporterName', currentUserName);

            const phpBackendUrl = 'submit_item_to_json.php'; // PHP endpoint for items

            try {
                // When sending FormData, set 'Content-Type' header is usually not needed
                // as the browser sets it automatically to 'multipart/form-data'
                const response = await fetch(phpBackendUrl, {
                    method: 'POST',
                    body: formData, // Send FormData directly
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    showMessage(result.message, 'success');
                    itemForm.reset(); // Clear the form on success
                    // Refresh the relevant list after submission
                    if (formData.get('itemType') === 'lost') { // Use formData.get() to read values
                        fetchItems('lost');
                        document.getElementById('lost-items').classList.remove('hidden');
                        document.getElementById('report-item').classList.add('hidden');
                    } else if (formData.get('itemType') === 'found') {
                        fetchItems('found');
                        document.getElementById('found-items').classList.remove('hidden');
                        document.getElementById('report-item').classList.add('hidden');
                    }
                } else {
                    showMessage(result.message || 'Failed to report item.', 'error');
                }

            } catch (error) {
                console.error('Error submitting item:', error);
                showMessage('Network error or server unreachable. Ensure your PHP server is running and `submit_item_to_json.php` is accessible.', 'error');
            }
        });

        // --- Fetch and Display Lost/Found Items (from server-side JSON) ---
        async function fetchItems(type) {
            const listContainer = type === 'lost' ? document.getElementById('lostItemsList') : document.getElementById('foundItemsList');
            listContainer.innerHTML = '<p class="text-gray-600 text-center col-span-full">Loading items...</p>';

            // Now fetching data from a PHP backend for actual storage
            const phpBackendUrl = `get_items_from_json.php?type=${type}`; // New PHP endpoint for items

            try {
                const response = await fetch(phpBackendUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const items = await response.json(); // Assuming PHP returns an array of items
                displayItems(items, listContainer);

            } catch (error) {
                console.error('Error fetching items:', error);
                listContainer.innerHTML = '<p class="text-red-500 text-center col-span-full">Failed to load items. Ensure your PHP server is running and `get_items_from_json.php` is accessible.</p>';
            }
        }

        function displayItems(items, container) {
            container.innerHTML = ''; // Clear existing items
            // Filter items by type if necessary, though the PHP should handle this
            const filteredItems = items.filter(item => {
                const containerId = container.id;
                if (containerId === 'lostItemsList' && item.itemType === 'lost') return true;
                if (containerId === 'foundItemsList' && item.itemType === 'found') return true;
                return false;
            });

            if (filteredItems.length === 0) {
                container.innerHTML = `<p class="text-gray-600 text-center col-span-full">No ${container.id.includes('lost') ? 'lost' : 'found'} items reported yet.</p>`;
                return;
            }

            filteredItems.forEach(item => {
                const itemCard = document.createElement('div');
                itemCard.className = 'card p-6 flex flex-col justify-between';

                // Determine if "Mark as Found/Returned" button should be shown
                let markResolvedButtonHtml = '';
                if (currentUserId && item.reporterId === currentUserId && item.status !== 'resolved') {
                    markResolvedButtonHtml = `<button class="btn-mark-resolved text-sm py-2 px-4 ml-2" data-id="${item.id}" onclick="markItemResolved(this.dataset.id)">Mark as Found/Returned</button>`;
                }
                const itemStatusText = item.status === 'resolved' ? '<span class="text-green-600 font-semibold">Status: Resolved</span>' : '<span class="text-red-600 font-semibold">Status: Active</span>';

                // Add "Chat with Reporter" button (visible to all, but only works if reporter is not self)
                let chatWithReporterButtonHtml = '';
                if (currentUserId && item.reporterId && item.reporterId !== currentUserId) {
                    chatWithReporterButtonHtml = `<button class="btn-secondary text-sm py-2 px-4 ml-2" onclick="startPrivateChat('${item.reporterId}', '${item.reporterName}')">Chat with Reporter</button>`;
                } else if (currentUserId && item.reporterId === currentUserId && isAdmin) { // Admin chatting with self-reported item
                     chatWithReporterButtonHtml = `<button class="btn-secondary text-sm py-2 px-4 ml-2" onclick="startPrivateChat('${item.reporterId}', '${item.reporterName}')">Chat with Self</button>`;
                } else if (currentUserId && !item.reporterId && isAdmin) { // Admin chatting with old item without reporter ID
                     chatWithReporterButtonHtml = `<button class="btn-secondary text-sm py-2 px-4 ml-2" onclick="startPrivateChat('${adminUserId}', '${adminUsername}')">Chat with Admin (Reporter Unknown)</button>`; // Use actual admin ID
                }


                itemCard.innerHTML = `
                    <div>
                        <h3 class="text-xl font-bold text-indigo-700 mb-2">${item.itemName}</h3>
                        <p class="text-gray-700 mb-3">${item.description}</p>
                        <p class="text-sm text-gray-600 mb-1"><strong class="font-medium">Location:</strong> ${item.location}</p>
                        <p class="text-sm text-gray-600 mb-4"><strong class="font-medium">Date:</strong> ${item.date}</p>
                        ${item.imagePath ? `<img src="${item.imagePath}" alt="Item Photo" class="w-full h-48 object-cover rounded-lg mb-4" onerror="this.onerror=null;this.src='https://placehold.co/400x200/cccccc/333333?text=No+Image';">` : `<img src="https://placehold.co/400x200/cccccc/333333?text=No+Image" alt="No Image" class="w-full h-48 object-cover rounded-lg mb-4">`}
                    </div>
                    <div class="mt-4 flex justify-between items-center">
                        <div>${itemStatusText}</div>
                        <div>
                            <button class="btn-primary text-sm py-2 px-4" data-id="${item.id}" data-type="item" onclick="reportItem(this.dataset.id)">Report Item</button>
                            ${markResolvedButtonHtml}
                            ${chatWithReporterButtonHtml}
                        </div>
                    </div>
                    <div>
                        <p class="text-sm text-gray-800 font-semibold mt-4">Contact:</p>
                        <p class="text-sm text-gray-700">Name: ${item.contactName} (ID: ${item.reporterId ? item.reporterId.substring(0, 8) + '...' : 'N/A'})</p>
                        <p class="text-sm text-gray-700">Email: <a href="mailto:${item.contactEmail}" class="text-indigo-600 hover:underline">${item.contactEmail}</a></p>
                        ${item.contactPhone ? `<p class="text-sm text-gray-700">Phone: ${item.contactPhone}</p>` : ''}
                    </div>
                `;
                container.appendChild(itemCard);
            });
        }

        // --- Community Chat Functionality (using server-side JSON file via PHP) ---
        const chatInput = document.getElementById('chatInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        const chatMessagesContainer = document.getElementById('chatMessages');

        // Function to fetch chat messages from the PHP backend
        async function fetchChatMessages() {
            try {
                const response = await fetch('get_chat_messages.php'); // Your PHP endpoint to read chat.json
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const messages = await response.json(); // Assuming PHP returns JSON array of messages
                displayChatMessages(messages);
            } catch (error) {
                console.error('Error fetching chat messages:', error);
                chatMessagesContainer.innerHTML = '<p class="text-red-500 text-center">Failed to load chat messages. Ensure your PHP server is running and `get_chat_messages.php` is accessible.</p>';
            }
        }

        // Function to display chat messages
        function displayChatMessages(messages) {
            const isScrolledToBottom = chatMessagesContainer.scrollHeight - chatMessagesContainer.clientHeight <= chatMessagesContainer.scrollTop + 1;

            chatMessagesContainer.innerHTML = ''; // Clear existing messages
            if (messages.length === 0) {
                chatMessagesContainer.innerHTML = '<p class="text-gray-600 text-center">No messages yet. Start the conversation!</p>';
                return;
            }

            messages.forEach(msg => {
                const messageElement = document.createElement('div');
                // Sanitize message content to prevent XSS (basic example)
                const sanitizedMessage = msg.message.replace(/</g, "&lt;").replace(/>/g, "&gt;");

                messageElement.className = `chat-message ${msg.senderId === currentUserId ? 'self' : ''}`;
                messageElement.innerHTML = `
                    <div class="sender">${msg.senderName || 'Anonymous User'} (ID: ${msg.senderId ? msg.senderId.substring(0, 8) + '...' : 'N/A'}):</div>
                    <div class="message-text">${sanitizedMessage}</div>
                    <div class="timestamp">${new Date(msg.timestamp).toLocaleString()}</div>
                `;
                chatMessagesContainer.appendChild(messageElement);
            });
            // Scroll to the bottom of the chat
            if (isScrolledToBottom) {
                chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
            }
        }

        // Function to send a chat message to the PHP backend
        sendMessageBtn.addEventListener('click', async () => {
            const messageText = chatInput.value.trim();
            if (messageText === '') {
                showMessage('Message cannot be empty!', 'error');
                return;
            }

            const message = {
                senderId: currentUserId,
                senderName: currentUserName, // Use the actual username from session
                message: messageText,
                timestamp: new Date().toISOString() // ISO string for easy storage and parsing
            };

            try {
                const response = await fetch('send_chat_message.php', { // Your PHP endpoint to write to chat.json
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(message)
                });

                const result = await response.json(); 
                console.log('send_chat_message.php response.ok:', response.ok); // Debugging
                console.log('send_chat_message.php result:', result); // Debugging

                if (response.ok && result.success) {
                    showMessage(result.message, 'success');
                    chatInput.value = ''; // Clear input field on success
                    fetchChatMessages(); // Refresh messages to show the new one
                } else {
                    showMessage(result.message || 'Failed to send message. Check server logs.', 'error');
                }
            } catch (error) {
                console.error('Error sending message:', error);
                showMessage('Network error or server unreachable. Ensure your PHP server is running.', 'error');
            }
        });

        // Allow sending message with Enter key
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessageBtn.click();
            }
        });

        // Set up polling to refresh chat messages every few seconds
        let chatPollingInterval;
        let privateChatPollingInterval; // New interval for private chat

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault(); // Prevent default anchor behavior
                const targetId = link.getAttribute('href').substring(1); // Get section ID

                sections.forEach(section => {
                    section.classList.add('hidden'); // Hide all sections
                });

                document.getElementById(targetId).classList.remove('hidden'); // Show target section

                // Clear all polling intervals when navigating
                clearInterval(chatPollingInterval);
                clearInterval(privateChatPollingInterval);
                chatPollingInterval = null;
                privateChatPollingInterval = null;

                // Specific actions for each section
                if (targetId === 'lost-items') {
                    fetchItems('lost');
                } else if (targetId === 'found-items') {
                    fetchItems('found');
                } else if (targetId === 'chat-option') {
                    fetchChatMessages(); // Initial fetch
                    chatPollingInterval = setInterval(fetchChatMessages, 3000); // Start polling
                } else if (targetId === 'private-chat') {
                    setupPrivateChatUI(); // Setup private chat UI based on user role
                    // Polling for private chat will start after a chat partner is selected
                }
                else if (targetId === 'admin-panel') {
                    if (isAdmin) { // Only fetch admin data if user is recognized as admin
                        fetchAllItemsForAdmin();
                        fetchAllUsersForAdmin();
                    } else {
                        showMessage('Access Denied: You are not authorized to view the admin panel.', 'error');
                        document.getElementById('admin-panel').classList.add('hidden'); // Ensure it stays hidden
                    }
                }
            });
        });

        // --- Admin Panel Functions ---
        const adminItemsList = document.getElementById('adminItemsList');
        const adminUsersList = document.getElementById('adminUsersList');

        async function fetchAllItemsForAdmin() {
            adminItemsList.innerHTML = '<tr><td colspan="8" class="text-center text-gray-500">Loading all items...</td></tr>';
            try {
                const response = await fetch('get_all_items.php'); // New PHP endpoint
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const items = await response.json();
                displayAdminItems(items);
            } catch (error) {
                console.error('Error fetching all items for admin:', error);
                adminItemsList.innerHTML = '<tr><td colspan="8" class="text-center text-red-500">Failed to load items. Admin access required.</td></tr>';
            }
        }

        function displayAdminItems(items) {
            adminItemsList.innerHTML = '';
            if (items.length === 0) {
                adminItemsList.innerHTML = '<tr><td colspan="8" class="text-center text-gray-500">No items found.</td></tr>';
                return;
            }
            items.forEach(item => {
                const row = document.createElement('tr');
                const imageHtml = item.imagePath ?
                    `<img src="${item.imagePath}" alt="Item" class="w-16 h-16 object-cover rounded-md" onerror="this.onerror=null;this.src='https://placehold.co/64x64/cccccc/333333?text=N/A';">` :
                    `<img src="https://placehold.co/64x64/cccccc/333333?text=No+Image" alt="No Image" class="w-16 h-16 object-cover rounded-md">`;
                const reportedStatus = item.reported ? 'Yes' : 'No';
                const reportedClass = item.reported ? 'reported' : '';
                const itemStatusText = item.status === 'resolved' ? '<span class="text-green-600 font-semibold">Resolved</span>' : '<span class="text-red-600 font-semibold">Active</span>';


                row.innerHTML = `
                    <td>${item.id ? item.id.substring(0, 8) + '...' : 'N/A'}</td>
                    <td>${item.itemType}</td>
                    <td>${item.itemName}</td>
                    <td>${item.reporterName || 'N/A'} (ID: ${item.reporterId ? item.reporterId.substring(0, 8) + '...' : 'N/A'})</td>
                    <td>${item.date}</td>
                    <td>${imageHtml}</td>
                    <td>
                        <button class="btn-report-status ${reportedClass}" data-id="${item.id}" data-type="item" data-reported="${item.reported ? 'true' : 'false'}">
                            ${reportedStatus}
                        </button>
                    </td>
                    <td>
                        ${itemStatusText}
                        <button class="btn-delete ml-2" data-id="${item.id}" data-type="item">Delete</button>
                    </td>
                `;
                adminItemsList.appendChild(row);
            });
            // Add event listeners to newly created delete and report status buttons
            adminItemsList.querySelectorAll('.btn-delete').forEach(button => {
                button.addEventListener('click', (e) => deleteAdminData(e.target.dataset.id, e.target.dataset.type));
            });
            adminItemsList.querySelectorAll('.btn-report-status').forEach(button => {
                button.addEventListener('click', (e) => toggleReportStatus(e.target.dataset.id, e.target.dataset.reported));
            });
        }

        async function fetchAllUsersForAdmin() {
            adminUsersList.innerHTML = '<tr><td colspan="3" class="text-center text-gray-500">Loading all users...</td></tr>';
            try {
                const response = await fetch('get_all_users.php'); // New PHP endpoint
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const users = await response.json();
                displayAdminUsers(users);
            } catch (error) {
                console.error('Error fetching all users for admin:', error);
                adminUsersList.innerHTML = '<tr><td colspan="3" class="text-center text-red-500">Failed to load users. Admin access required.</td></tr>';
            }
        }

        function displayAdminUsers(users) {
            adminUsersList.innerHTML = '';
            if (users.length === 0) {
                adminUsersList.innerHTML = '<tr><td colspan="3" class="text-center text-gray-500">No users found.</td></tr>';
                return;
            }
            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.id ? user.id.substring(0, 8) + '...' : 'N/A'}</td>
                    <td>${user.username}</td>
                    <td>
                        <button class="btn-delete" data-id="${user.id}" data-type="user">Delete</button>
                    </td>
                `;
                adminUsersList.appendChild(row);
            });
            // Add event listeners to newly created delete buttons
            adminUsersList.querySelectorAll('.btn-delete').forEach(button => {
                button.addEventListener('click', (e) => deleteAdminData(e.target.dataset.id, e.target.dataset.type));
            });
        }

        async function deleteAdminData(id, type) {
            if (!confirm(`Are you sure you want to delete this ${type}?`)) { // Using confirm for simplicity, replace with custom modal in production
                return;
            }

            const endpoint = type === 'item' ? 'delete_item.php' : 'delete_user.php';
            const payload = type === 'item' ? { itemId: id } : { userId: id };

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    showMessage(`${type} deleted successfully!`, 'success');
                    // Refresh the respective list
                    if (type === 'item') {
                        fetchAllItemsForAdmin();
                    } else {
                        fetchAllUsersForAdmin();
                    }
                } else {
                    showMessage(result.message || `Failed to delete ${type}. Admin access required.`, 'error');
                }
            } catch (error) {
                console.error(`Error deleting ${type}:`, error);
                showMessage(`Network error during ${type} deletion.`, 'error');
            }
        }

        // New function to report an item from the public view
        async function reportItem(itemId) {
            if (!confirm('Are you sure you want to report this item? This action will be visible to administrators.')) {
                return;
            }

            try {
                const response = await fetch('report_item.php', { // New PHP endpoint
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ itemId: itemId }),
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    showMessage(result.message, 'success');
                    // Optionally refresh the current list to show updated status if desired
                    // For now, just show message
                } else {
                    showMessage(result.message || 'Failed to report item.', 'error');
                }
            } catch (error) {
                console.error('Error reporting item:', error);
                showMessage('Network error during reporting. Please try again.', 'error');
            }
        }

        // New function for admin to toggle reported status (e.g., mark as reviewed)
        async function toggleReportStatus(itemId, currentReportedStatus) {
            const newStatus = currentReportedStatus === 'true' ? false : true; // Toggle boolean
            const actionText = newStatus ? 'mark as reported' : 'clear report status';

            if (!confirm(`Are you sure you want to ${actionText} for this item?`)) {
                return;
            }

            try {
                const response = await fetch('toggle_item_report_status.php', { // New PHP endpoint
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ itemId: itemId, reported: newStatus }),
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    showMessage(result.message, 'success');
                    fetchAllItemsForAdmin(); // Refresh admin items list to show updated status
                } else {
                    showMessage(result.message || `Failed to ${actionText}.`, 'error');
                }
            } catch (error) {
                console.error(`Error toggling report status:`, error);
                showMessage(`Network error during status update.`, 'error');
            }
        }

        // New function to mark an item as resolved (only by reporter)
        async function markItemResolved(itemId) {
            if (!confirm('Are you sure you want to mark this item as Found/Returned? This will update its status.')) {
                return;
            }

            try {
                const response = await fetch('mark_item_resolved.php', { // New PHP endpoint
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ itemId: itemId }),
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    showMessage(result.message, 'success');
                    // Refresh the current view to reflect the status change
                    const currentSection = document.querySelector('main section:not(.hidden)').id;
                    if (currentSection === 'lost-items') {
                        fetchItems('lost');
                    } else if (currentSection === 'found-items') {
                        fetchItems('found');
                    }
                } else {
                    showMessage(result.message || 'Failed to mark item as resolved.', 'error');
                }
            } catch (error) {
                console.error('Error marking item resolved:', error);
                showMessage('Network error during status update. Please try again.', 'error');
            }
        }

        // --- Private Chat Logic ---
        const privateChatUsersList = document.getElementById('privateChatUsersList');
        const userChatAdmin = document.getElementById('userChatAdmin');
        const adminChatList = document.getElementById('adminChatList');
        const startAdminChatBtn = document.getElementById('startAdminChatBtn');
        const privateChatWindow = document.getElementById('privateChatWindow');
        const privateChatPartnerName = document.getElementById('privateChatPartnerName');
        const privateChatMessagesContainer = document.getElementById('privateChatMessages');
        const privateChatInput = document.getElementById('privateChatInput');
        const sendPrivateMessageBtn = document.getElementById('sendPrivateMessageBtn');

        let currentPrivateChatPartnerId = null;
        let currentPrivateChatPartnerName = null;

        function setupPrivateChatUI() {
            if (isAdmin) {
                adminChatList.classList.remove('hidden');
                userChatAdmin.classList.add('hidden');
                fetchPrivateChatUsers(); // Admin fetches list of users
            } else {
                adminChatList.classList.add('hidden');
                userChatAdmin.classList.remove('hidden');
                // Regular user can only chat with admin
                // Use the fetched adminUserId and adminUsername
                if (adminUserId && adminUsername) {
                    startAdminChatBtn.onclick = () => startPrivateChat(adminUserId, adminUsername);
                } else {
                    startAdminChatBtn.disabled = true;
                    startAdminChatBtn.textContent = 'Admin Not Available';
                }
            }
            privateChatWindow.classList.add('hidden'); // Hide chat window initially
            privateChatMessagesContainer.innerHTML = '<p class="text-gray-600 text-center">Select a user to start chatting.</p>';
        }

        // Admin: Fetch list of users to chat with
        async function fetchPrivateChatUsers() {
            privateChatUsersList.innerHTML = '<li class="p-4 text-gray-500">Loading users...</li>';
            try {
                const response = await fetch('get_private_chat_users.php'); // New PHP endpoint
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const users = await response.json();
                displayPrivateChatUsers(users);
            } catch (error) {
                console.error('Error fetching private chat users:', error);
                privateChatUsersList.innerHTML = '<li class="p-4 text-red-500">Failed to load users.</li>';
            }
        }

        function displayPrivateChatUsers(users) {
            privateChatUsersList.innerHTML = '';
            if (users.length === 0) {
                privateChatUsersList.innerHTML = '<li class="p-4 text-gray-500">No other users to chat with.</li>';
                return;
            }
            // Add 'Admin' as an option for admin to chat with themselves (for testing)
            // This is useful for admin to see how messages appear from their own side
            if (isAdmin && currentUserId && currentUserName) {
                 const adminSelfItem = document.createElement('li');
                 adminSelfItem.className = 'p-4 cursor-pointer hover:bg-gray-100 rounded-lg';
                 adminSelfItem.textContent = `${currentUserName} (Self)`; // Display "Admin (Self)"
                 adminSelfItem.dataset.id = currentUserId;
                 adminSelfItem.dataset.name = currentUserName;
                 adminSelfItem.onclick = () => startPrivateChat(adminSelfItem.dataset.id, adminSelfItem.dataset.name);
                 privateChatUsersList.appendChild(adminSelfItem);
            }


            users.forEach(user => {
                const listItem = document.createElement('li');
                listItem.className = 'p-4 cursor-pointer hover:bg-gray-100 rounded-lg';
                listItem.textContent = `${user.username} (ID: ${user.id.substring(0, 8)}...)`;
                listItem.dataset.id = user.id;
                listItem.dataset.name = user.username;
                listItem.onclick = () => startPrivateChat(user.id, user.username);
                privateChatUsersList.appendChild(listItem);
            });
        }

        // Function to start a private chat with a specific user
        function startPrivateChat(partnerId, partnerName) {
            currentPrivateChatPartnerId = partnerId;
            currentPrivateChatPartnerName = partnerName;

            privateChatPartnerName.textContent = `Chat with: ${partnerName}`;
            privateChatWindow.classList.remove('hidden');
            privateChatMessagesContainer.innerHTML = '<p class="text-gray-600 text-center">Loading messages...</p>';

            // Highlight selected user in admin list
            privateChatUsersList.querySelectorAll('li').forEach(li => li.classList.remove('selected'));
            const selectedLi = privateChatUsersList.querySelector(`li[data-id="${partnerId}"]`);
            if (selectedLi) selectedLi.classList.add('selected');


            // Start polling for private messages
            clearInterval(privateChatPollingInterval); // Clear any existing interval
            fetchPrivateMessages(); // Initial fetch
            privateChatPollingInterval = setInterval(fetchPrivateMessages, 2000); // Poll every 2 seconds
        }

        // Fetch private messages for the current chat partner
        async function fetchPrivateMessages() {
            if (!currentPrivateChatPartnerId) return;

            try {
                const response = await fetch(`get_private_messages.php?partnerId=${currentPrivateChatPartnerId}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const messages = await response.json();
                displayPrivateMessages(messages);
            } catch (error) {
                console.error('Error fetching private messages:', error);
                privateChatMessagesContainer.innerHTML = '<p class="text-red-500 text-center">Failed to load private messages.</p>';
            }
        }

        // Display private messages
        function displayPrivateMessages(messages) {
            const isScrolledToBottom = privateChatMessagesContainer.scrollHeight - privateChatMessagesContainer.clientHeight <= privateChatMessagesContainer.scrollTop + 1;

            privateChatMessagesContainer.innerHTML = '';
            if (messages.length === 0) {
                privateChatMessagesContainer.innerHTML = '<p class="text-gray-600 text-center">No messages in this private chat yet.</p>';
                return;
            }

            messages.forEach(msg => {
                const messageElement = document.createElement('div');
                const sanitizedMessage = msg.message.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                messageElement.className = `chat-message ${msg.senderId === currentUserId ? 'self' : ''}`;
                messageElement.innerHTML = `
                    <div class="sender">${msg.senderName}:</div>
                    <div class="message-text">${sanitizedMessage}</div>
                    <div class="timestamp">${new Date(msg.timestamp).toLocaleString()}</div>
                `;
                privateChatMessagesContainer.appendChild(messageElement);
            });

            // Scroll to bottom if already at bottom or new messages arrive
            if (isScrolledToBottom) {
                privateChatMessagesContainer.scrollTop = privateChatMessagesContainer.scrollHeight;
            }
        }

        // Send private message
        sendPrivateMessageBtn.addEventListener('click', async () => {
            const messageText = privateChatInput.value.trim();
            if (messageText === '' || !currentPrivateChatPartnerId) {
                showMessage('Message cannot be empty or no chat partner selected!', 'error');
                return;
            }

            const message = {
                partnerId: currentPrivateChatPartnerId,
                message: messageText,
                // senderId and senderName will be added by PHP from session
                timestamp: new Date().toISOString()
            };

            try {
                const response = await fetch('send_private_message.php', { // New PHP endpoint
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(message)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    privateChatInput.value = '';
                    fetchPrivateMessages(); // Refresh messages
                } else {
                    showMessage(result.message || 'Failed to send private message.', 'error');
                }
            } catch (error) {
                console.error('Error sending private message:', error);
                showMessage('Network error sending private message. Please try again.', 'error');
            }
        });

        privateChatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendPrivateMessageBtn.click();
            }
        });

    </script>
</body>
</html>

